import{r as s,j as o,K as G,L as V,S as P}from"./app-jXP9Ka1N.js";import{a as W,c as F,b as X,B as $}from"./app-logo-icon-BKQdXPXt.js";import{I as Y}from"./index-DLUHbalH.js";import{A as K}from"./app-layout-CeBI1KcM.js";import"./index-3f0GmHFW.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Z=W("Info",Q),L="data: ",_=(e,{eventName:t="update",endSignal:r="</stream>",glue:n=" ",replace:i=!1,onMessage:h=()=>null,onComplete:w=()=>null,onError:C=()=>null}={})=>{const d=s.useRef(null),a=s.useRef([]),g=s.useMemo(()=>Array.isArray(t)?t:[t],Array.isArray(t)?t:[t]),[E,k]=s.useState(""),[m,S]=s.useState([]),y=s.useCallback(()=>{a.current=[],k(""),S([])},[]),f=s.useCallback(l=>{if([r,`${L}${r}`].includes(l.data)){p(),w();return}i&&y(),a.current.push(l.data.startsWith(L)?l.data.substring(L.length):l.data),k(a.current.join(n)),S(a.current),h(l)},[g,n]),j=s.useCallback(l=>{C(l),p()},[]),p=s.useCallback((l=!1)=>{var c,b;g.forEach(x=>{var u;(u=d.current)==null||u.removeEventListener(x,f)}),(c=d.current)==null||c.removeEventListener("error",j),(b=d.current)==null||b.close(),d.current=null,l&&y()},[]);return s.useEffect(()=>(y(),d.current=new EventSource(e),g.forEach(l=>{var c;(c=d.current)==null||c.addEventListener(l,f)}),d.current.addEventListener("error",j),p),[e,g,f,j,y]),{message:E,messageParts:m,close:p,clearMessage:y}},ee="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let te=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=ee[r[e]&63];return t};const A=new Map,re=(e,t)=>{A.has(e)||A.set(e,{onData:[],onError:[],onFinish:[],onResponse:[],onCancel:[],onBeforeSend:[]});const r=A.get(e);return t.onData&&r.onData.push(t.onData),t.onError&&r.onError.push(t.onError),t.onFinish&&r.onFinish.push(t.onFinish),t.onResponse&&r.onResponse.push(t.onResponse),t.onCancel&&r.onCancel.push(t.onCancel),t.onBeforeSend&&r.onBeforeSend.push(t.onBeforeSend),()=>{le(e,t)}},D=(e,t,...r)=>{const n=A.get(e);return n?n[t].map(i=>i(...r)):[]},U=e=>{D(e,"onFinish")},O=(e,t)=>{D(e,"onError",t)},ne=(e,t)=>{D(e,"onResponse",t)},se=e=>{D(e,"onCancel")},oe=(e,t)=>{D(e,"onData",t)},ae=(e,t)=>{const r=D(e,"onBeforeSend",t);for(const n of r){if(n===!1)return!1;if(n!==null&&typeof n=="object")return n}return null},le=(e,t)=>{const r=A.get(e);r&&(t.onData&&(r.onData=r.onData.filter(n=>n!==t.onData)),t.onError&&(r.onError=r.onError.filter(n=>n!==t.onError)),t.onFinish&&(r.onFinish=r.onFinish.filter(n=>n!==t.onFinish)),t.onResponse&&(r.onResponse=r.onResponse.filter(n=>n!==t.onResponse)),t.onCancel&&(r.onCancel=r.onCancel.filter(n=>n!==t.onCancel)),t.onBeforeSend&&(r.onBeforeSend=r.onBeforeSend.filter(n=>n!==t.onBeforeSend)))},B=new Map,N=new Map,I=e=>{const t=B.get(e);if(t)return t;const r={controller:new AbortController,data:"",isFetching:!1,isStreaming:!1,jsonData:null};return B.set(e,r),r},J=e=>(N.has(e)||N.set(e,[]),N.get(e)),H=e=>{var t;return N.has(e)&&((t=N.get(e))==null?void 0:t.length)},ie=(e,t)=>(J(e).push(t),()=>{N.set(e,J(e).filter(r=>r!==t)),H(e)||(B.delete(e),N.delete(e))}),ce=(e,t)=>{var r;B.set(e,{...I(e),...t});const n=I(e);(r=N.get(e))==null||r.forEach(i=>i(n))},q=(e,t={})=>{const r=s.useRef(t.id??te()),n=s.useRef(I(r.current)),i=s.useRef((()=>{var l;const c={"Content-Type":"application/json","X-STREAM-ID":r.current},b=t.csrfToken??((l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content"));return b&&(c["X-CSRF-TOKEN"]=b),c})()),[h,w]=s.useState(n.current.data),[C,d]=s.useState(n.current.jsonData),[a,g]=s.useState(n.current.isFetching),[E,k]=s.useState(n.current.isStreaming),m=s.useCallback(l=>{ce(r.current,l)},[]),S=s.useCallback(()=>{n.current.controller.abort(),(a||E)&&se(r.current),m({isFetching:!1,isStreaming:!1})},[a,E]),y=s.useCallback(()=>{m({data:"",jsonData:null})},[]),f=s.useCallback(l=>{const c=new AbortController,b={method:"POST",signal:c.signal,headers:{...i.current,...t.headers??{}},body:JSON.stringify(l??{}),credentials:t.credentials??"same-origin"},x=ae(r.current,b);x!==!1&&(m({isFetching:!0,controller:c}),fetch(e,x??b).then(async u=>{if(!u.ok){const v=await u.text();throw new Error(v)}if(!u.body)throw new Error("ReadableStream not yet supported in this browser.");return ne(r.current,u),m({isFetching:!1,isStreaming:!0}),p(u.body.getReader())}).catch(u=>{m({isFetching:!1,isStreaming:!1}),O(r.current,u),U(r.current)}))},[e]),j=s.useCallback(l=>{S(),f(l),y()},[]),p=s.useCallback((l,c="")=>l.read().then(({done:b,value:x})=>{const u=new TextDecoder("utf-8").decode(x),v=c+u;oe(r.current,u);const R={data:v};if(!b)return m(R),p(l,v);if(R.isStreaming=!1,t.json)try{R.jsonData=JSON.parse(v)}catch(T){O(r.current,T)}return m(R),U(r.current),""}),[]);return s.useEffect(()=>{const l=ie(r.current,c=>{n.current=I(r.current),g(c.isFetching),k(c.isStreaming),w(c.data),d(c.jsonData)});return()=>{l(),H(r.current)||S()}},[]),s.useEffect(()=>{const l=re(r.current,t);return()=>{l()}},[t]),s.useEffect(()=>(window.addEventListener("beforeunload",S),()=>{window.removeEventListener("beforeunload",S)}),[S]),s.useEffect(()=>{t.initialInput&&f(t.initialInput)},[]),{data:h,jsonData:C,isFetching:a,isStreaming:E,id:r.current,send:j,cancel:S,clearData:y}};function ue({id:e,className:t}){const{isFetching:r,isStreaming:n}=q("chat",{id:e});return n?o.jsx("div",{className:F("size-2 animate-pulse rounded-full bg-green-500",t)}):r?o.jsx("div",{className:F("size-2 animate-pulse rounded-full bg-yellow-500",t)}):null}function de({messages:e,streamingData:t,isStreaming:r,streamId:n}){const i=s.useRef(null),[h,w]=s.useState(!0),C=s.useCallback(()=>{const a=i.current;return a?Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=1:!1},[]),d=s.useCallback(()=>{const a=C();w(a)},[C]);return s.useEffect(()=>{i.current&&h&&(i.current.scrollTop=i.current.scrollHeight)},[e.length,t,h]),s.useEffect(()=>{const a=i.current;if(a)return a.addEventListener("scroll",d),()=>a.removeEventListener("scroll",d)},[d]),o.jsx("div",{ref:i,className:"flex-1 overflow-x-hidden overflow-y-auto",children:o.jsxs("div",{className:"mx-auto max-w-3xl space-y-4 p-4",children:[e.length===0&&o.jsx("p",{className:"text-muted-foreground mt-8 text-center",children:"Type your message below and hit enter to send."}),e.map((a,g)=>{const E=a.id?`db-${a.id}`:`local-${g}-${a.content.substring(0,10)}`;return o.jsx("div",{className:F("relative",a.type==="prompt"&&"flex justify-end"),children:o.jsxs("div",{className:F("inline-block max-w-[80%] rounded-lg p-3",a.type==="prompt"?"bg-primary text-primary-foreground":"bg-muted"),children:[a.type==="prompt"&&(g===e.length-1||g===e.length-2)&&n&&o.jsx(ue,{id:n,className:"absolute top-3 -left-8"}),o.jsx("p",{className:"whitespace-pre-wrap",children:a.content})]})},E)}),t&&o.jsx("div",{className:"relative",children:o.jsx("div",{className:"bg-muted inline-block max-w-[80%] rounded-lg p-3",children:o.jsx("p",{className:"whitespace-pre-wrap",children:t})})})]})})}function fe({chatId:e,onTitleUpdate:t,onComplete:r}){return _(`/chat/${e}/title-stream`,{eventName:"title-update",endSignal:"</stream>",onMessage:n=>{try{const i=JSON.parse(n.data);i.title&&t(i.title,!1)}catch(i){console.error("Error parsing title JSON:",i)}},onComplete:()=>{r()},onError:n=>{console.error("Title generation error:",n),r()}}),null}function me({chatId:e,onComplete:t}){return _(`/chat/${e}/title-stream`,{eventName:"title-update",endSignal:"</stream>",onMessage:r=>{try{const n=JSON.parse(r.data);n.title&&window.dispatchEvent(new CustomEvent("chatTitleUpdated",{detail:{chatId:e,newTitle:n.title}}))}catch(n){console.error("Error parsing sidebar title:",n)}},onComplete:()=>{t()},onError:r=>{console.error("Sidebar title update error:",r),t()}}),null}const pe=X("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-background text-foreground",destructive:"text-destructive-foreground [&>svg]:text-current *:data-[slot=alert-description]:text-destructive-foreground/80"}},defaultVariants:{variant:"default"}});function ge({className:e,variant:t,...r}){return o.jsx("div",{"data-slot":"alert",role:"alert",className:F(pe({variant:t}),e),...r})}function xe({className:e,...t}){return o.jsx("div",{"data-slot":"alert-description",className:F("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",e),...t})}function ve({chat:e,auth:t,flash:r}){const[n,i]=s.useState((e==null?void 0:e.messages)||[]),[h,w]=s.useState((e==null?void 0:e.title)||"Untitled"),[C,d]=s.useState(!1),[a,g]=s.useState(!1),[E,k]=s.useState(!1),m=s.useRef(null),S=(e==null?void 0:e.id)||null,y=S?`/chat/${S}/stream`:"/chat/stream",{data:f,send:j,isStreaming:p,isFetching:l,id:c}=q(y);s.useEffect(()=>{var u,v;(u=m.current)==null||u.focus(),(((v=e==null?void 0:e.messages)==null?void 0:v.length)===1||(r==null?void 0:r.stream)&&(e==null?void 0:e.messages)&&e.messages.length>0)&&setTimeout(()=>{j({messages:e.messages})},100)},[e==null?void 0:e.messages,r==null?void 0:r.stream,j]),s.useEffect(()=>{p&&window.scrollTo(0,document.body.scrollHeight)},[p,f]),s.useEffect(()=>{!p&&m.current&&(m.current.focus(),t.user&&e&&h==="Untitled"&&f&&f.trim()&&(d(!0),k(!0)))},[p,t.user,e,h,f]),s.useEffect(()=>{e!=null&&e.title&&w(e.title)},[e==null?void 0:e.title]),s.useEffect(()=>{},[h,a]);const b=s.useCallback(x=>{var M;x.preventDefault();const v=x.currentTarget.querySelector("input"),R=v==null?void 0:v.value.trim();if(!R)return;const T=[];f&&f.trim()&&T.push({type:"response",content:f}),T.push({type:"prompt",content:R}),i(z=>[...z,...T]),j({messages:[...n,...T]}),v.value="",(M=m.current)==null||M.focus()},[j,f,n]);return o.jsxs(o.Fragment,{children:[o.jsx(V,{title:h}),C&&t.user&&e&&o.jsx(fe,{chatId:e.id,onTitleUpdate:(x,u=!1)=>{w(x),g(u),document.title=`${x} - LaraChat`},onComplete:()=>{g(!1),d(!1)}}),E&&t.user&&e&&o.jsx(me,{chatId:e.id,onComplete:()=>{k(!1)}}),o.jsxs(K,{currentChatId:e==null?void 0:e.id,className:"flex h-[calc(100vh-theme(spacing.4))] flex-col overflow-hidden md:h-[calc(100vh-theme(spacing.8))]",children:[!t.user&&o.jsx("div",{className:"bg-background flex-shrink-0 border-b p-4",children:o.jsxs(ge,{className:"mx-auto max-w-3xl",children:[o.jsx(Z,{className:"h-4 w-4"}),o.jsxs(xe,{children:["You're chatting anonymously. Your conversation won't be saved.",o.jsx($,{variant:"link",className:"h-auto p-0 text-sm",onClick:()=>P.visit("/login"),children:"Sign in to save your chats"})]})]})}),t.user&&e&&o.jsx("div",{className:"bg-background flex-shrink-0 border-b px-4 py-3",children:o.jsx("div",{className:"mx-auto max-w-3xl",children:o.jsxs("h1",{className:"text-lg font-semibold text-foreground",children:[h,a&&o.jsx("span",{className:"ml-1 animate-pulse",children:"|"})]})})}),o.jsx(de,{messages:n,streamingData:f,isStreaming:p,streamId:c}),o.jsx("div",{className:"bg-background flex-shrink-0 border-t",children:o.jsx("div",{className:"mx-auto max-w-3xl p-4",children:o.jsx("form",{onSubmit:b,children:o.jsxs("div",{className:"flex gap-2",children:[o.jsx(Y,{ref:m,type:"text",placeholder:"Type a message...",className:"flex-1",disabled:p||l}),o.jsx($,{type:"submit",disabled:p||l,children:"Send"})]})})})})]})]})}function Ee(){const{auth:e,chat:t,flash:r}=G().props,n=t!=null&&t.id?`chat-${t.id}`:"no-chat";return o.jsx(ve,{chat:t,auth:e,flash:r},n)}export{Ee as default};
